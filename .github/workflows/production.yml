name: Music Player production

on:
    push:
        branches:
            - master

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            -   name: SSH into remote server and execute commands
                uses: appleboy/ssh-action@master
                with:
                    host: 103.148.57.174
                    username: root
                    key: ${{ secrets.SSH_PRIVATE_KEY }}
                    command_timeout: 20m
                    script: |
                        cd /root/music-player && \
                        echo "üì• Fetching latest code..." && \
                        git status && \
                        git reset --hard && \
                        BEFORE=$(git rev-parse HEAD) && \
                        git pull origin master && \
                        AFTER=$(git rev-parse HEAD) && \

                        # Check if package.json or Dockerfile changed (need rebuild)
                        if git diff --name-only $BEFORE $AFTER | grep -qE '^(package\.json|Dockerfile)$'; then
                          echo "üî® Dependencies or Dockerfile changed, rebuilding..." && \
                          docker compose down && \
                          docker compose build --no-cache && \
                          docker compose up -d && \
                          docker system prune -f
                        else
                          echo "‚ôªÔ∏è  Only code changes, restarting container..." && \
                          docker compose restart
                        fi && \

                        echo "‚úÖ Deployment completed!" && \
                        echo "üìä Container status:" && \
                        docker compose ps && \
                        echo "üìù Recent logs:" && \
                        docker compose logs --tail 20
