name: Music Player production

on:
    push:
        branches:
            - master

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            -   name: SSH into remote server and execute commands
                uses: appleboy/ssh-action@master
                with:
                    host: 103.148.57.174
                    username: root
                    key: ${{ secrets.SSH_PRIVATE_KEY }}
                    command_timeout: 20m
                    script: |
                        cd /root/music-player && \
                        echo "ğŸ“¥ Fetching latest code..." && \
                        git status && \
                        git reset --hard && \
                        BEFORE=$(git rev-parse HEAD) && \
                        git pull origin master && \
                        AFTER=$(git rev-parse HEAD) && \

                        # Determine what changed
                        CHANGED_FILES=$(git diff --name-only $BEFORE $AFTER) && \
                        echo "ğŸ“ Changed files:" && \
                        echo "$CHANGED_FILES" && \

                        # Check for different types of changes
                        DEPS_CHANGED=$(echo "$CHANGED_FILES" | grep -qE '^(package\.json|package-lock\.json)$' && echo "yes" || echo "no") && \
                        DOCKERFILE_CHANGED=$(echo "$CHANGED_FILES" | grep -qE '^(Dockerfile|docker-compose\.yml)$' && echo "yes" || echo "no") && \
                        MIGRATIONS_CHANGED=$(echo "$CHANGED_FILES" | grep -qE '^(migrations/|migrate\.js)$' && echo "yes" || echo "no") && \

                        echo "ğŸ” Changes detected:" && \
                        echo "  - Dependencies: $DEPS_CHANGED" && \
                        echo "  - Dockerfile: $DOCKERFILE_CHANGED" && \
                        echo "  - Migrations: $MIGRATIONS_CHANGED" && \

                        # Decide deployment strategy
                        if [ "$DOCKERFILE_CHANGED" = "yes" ] || [ "$DEPS_CHANGED" = "yes" ]; then
                          echo "ğŸ”¨ Dockerfile or dependencies changed, full rebuild required..." && \
                          echo "â¹ï¸  Stopping containers..." && \
                          docker compose down && \
                          echo "ğŸ—ï¸  Building new images (no cache)..." && \
                          docker compose build --no-cache && \
                          echo "ğŸš€ Starting containers..." && \
                          docker compose up -d && \
                          echo "ğŸ§¹ Cleaning up unused images..." && \
                          docker system prune -f && \
                          echo "âœ… Full rebuild completed!"
                        else
                          echo "â™»ï¸  Code-only changes, quick restart..." && \
                          docker compose restart && \
                          echo "âœ… Quick restart completed!"
                        fi && \

                        # Run migrations if needed (after container is up)
                        if [ "$MIGRATIONS_CHANGED" = "yes" ]; then
                          echo "ğŸ—„ï¸  Migrations detected, running migrations..." && \
                          sleep 3 && \
                          docker compose exec -T app node migrate.js && \
                          echo "âœ… Migrations completed!" || \
                          echo "âš ï¸  Migration failed or no migrations to run"
                        fi && \

                        # Health check
                        echo "" && \
                        echo "ğŸ“Š Deployment Summary:" && \
                        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" && \
                        echo "ğŸ“¦ Container Status:" && \
                        docker compose ps && \
                        echo "" && \
                        echo "ğŸ“ Recent Logs (last 20 lines):" && \
                        docker compose logs --tail 20 && \
                        echo "" && \
                        echo "âœ… Deployment completed successfully!" && \
                        echo "ğŸŒ Application should be running at http://103.148.57.174"
